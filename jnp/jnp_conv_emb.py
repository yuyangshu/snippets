import jax.numpy as jnp
import jax.lax as lax


input_size = 224
patch_size = 16
kernel_size = 8
stride = 4


h = w = 14
width = 768
temperature=10_000.

y, x = jnp.mgrid[:h, :w]
omega = jnp.arange(width // 4) / (width // 4 - 1)
omega = 1. / (temperature**omega)

y = jnp.einsum("m,d->md", y.flatten(), omega)
x = jnp.einsum("m,d->md", x.flatten(), omega)

pe = jnp.concatenate([jnp.sin(x), jnp.cos(x), jnp.sin(y), jnp.cos(y)], axis=1)
emb = jnp.asarray(pe, jnp.float32)[None, :, :]
emb_2d = jnp.reshape(emb, [h, w, -1])

# fill the embeddings into an image sized matrix
f = lambda i, j, k: emb_2d[i // patch_size, j // patch_size, k]
img = jnp.vectorize(f)(*jnp.indices((224, 224, 768)))
# see jnp_sincos2d_avg.py


# calculate weighted embedding for each scale
scales = [16] # [16, 32, 64, 128]
mean_embs = []
for scale in scales:
    h = scale // kernel_size # [2, 4, 8, 16]
    field_size = input_size // h # [112, 56, 28, 14]
    ratio = input_size // scale
    step = stride * ratio
    print(f"scale: {scale}, h: {h}, field_size: {field_size}, ratio: {ratio}, step: {step}")

    starts = []
    for i in range(0, input_size - field_size + 1, step):
        for j in range(0, input_size - field_size + 1, step):
            patch = lax.dynamic_slice(img, (i, j, 0), (field_size, field_size, 3))
            starts.append((i, j))
            print(i, j, patch, patch.mean(axis=(0, 1)))

    print(f"patch.shape: {patch.shape}, starts: {starts}")

    # f = lambda x: jnp.asarray(jnp.split(x, h, axis=1))
    # emb_at_scale = f(f(img))

    # if (scale == 16):
    #     print("emb_at_scale", emb_at_scale, emb_at_scale.shape)
    #     print("img", img, img.shape)
    #     print(jnp.all(jnp.equal(emb_at_scale[0, 0], img)))

    # mean_emb = emb_at_scale.mean(axis=(2, 3))
    # print(f"mean_emb[{scale}]", mean_emb, mean_emb.shape)

    # mean_embs.append(mean_emb)

# flat_embs = jnp.concatenate([jnp.reshape(x, (-1, width)) for x in mean_embs + [emb]])
# print("flat_embs", flat_embs, flat_embs.shape)









# scale: 16, h: 2, field_size: 112, ratio: 14, step: 56
# 0 0 [[[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]

#  [[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]

#  [[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]

#  ...

#  [[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]

#  [[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]

#  [[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]] [-0.0147507  -0.01672678 -0.00483462]
# 0 56 [[[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]

#  [[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]

#  [[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]

#  ...

#  [[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]

#  [[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]

#  [[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]] [-0.01973259  0.00474372  0.00398334]
# 0 112 [[[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]

#  [[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]

#  [[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]

#  ...

#  [[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]

#  [[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]

#  [[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]] [ 0.05686356  0.00624869 -0.00402363]
# 56 0 [[[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]

#  [[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]

#  [[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]

#  ...

#  [[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]

#  [[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]

#  [[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]] [-0.0147507  -0.01672678 -0.00483462]
# 56 56 [[[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]

#  [[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]

#  [[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]

#  ...

#  [[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]

#  [[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]

#  [[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]] [-0.01973259  0.00474372  0.00398334]
# 56 112 [[[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]

#  [[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]

#  [[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]

#  ...

#  [[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]

#  [[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]

#  [[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]] [ 0.05686356  0.00624869 -0.00402363]
# 112 0 [[[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]

#  [[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]

#  [[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]

#  ...

#  [[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]

#  [[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]

#  [[ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   [ 0.          0.          0.        ]
#   ...
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]
#   [-0.2794155  -0.53596455 -0.74117386]]] [-0.0147507  -0.01672678 -0.00483462]
# 112 56 [[[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]

#  [[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]

#  [[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]

#  ...

#  [[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]

#  [[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]

#  [[ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   [ 0.14112     0.27906942  0.40539292]
#   ...
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]
#   [-0.54402107 -0.10425853  0.3374106 ]]] [-0.01973259  0.00474372  0.00398334]
# 112 112 [[[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]

#  [[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]

#  [[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]

#  ...

#  [[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]

#  [[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]

#  [[ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   [ 0.6569866   0.37766436  0.07317832]
#   ...
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]
#   [ 0.42016706 -0.17743237 -0.6900611 ]]] [ 0.05686356  0.00624869 -0.00402363]
# patch.shape: (112, 112, 3), starts: [(0, 0), (0, 56), (0, 112), (56, 0), (56, 56), (56, 112), (112, 0), (112, 56), (112, 112)]



