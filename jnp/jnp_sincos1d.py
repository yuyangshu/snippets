import jax.numpy as jnp
import jax.lax as lax


l = 281 # 14 * 14 + 8 * 8 + 4 * 4 + 2 * 2 + 1 * 1
width = 768
temperature=10_000.


def P_validation(k, i):
    if (jnp.bitwise_and(i, 1)):
        return jnp.cos(k / temperature ** (2 * jnp.right_shift(i, 1) / width))
    else:
        return jnp.sin(k / temperature ** (2 * jnp.right_shift(i, 1) / width))


def P(v):
    # v: [15, 15, ..., 15], (768,)

    # [0, 1, ... 767]
    index = jnp.arange(width)
    # [0, 0, , 0.0026, 0.0026, ..., 0.9974, 0.9974]
    # 0.0026 = 2 / 768, 0.9974 = 766/768
    # y = 2 * jnp.right_shift(index, 1) / width
    # [15, 15, 14.6445, 14.6445, ..., 0.0015, 0.0015]
    y = v / temperature ** (2 * jnp.right_shift(index, 1) / width)

    # [0.65028787 -0.7596879   0.8740425  -0.48584944, ..., 0.00153641  0.9999988]
    return lax.select(jnp.bitwise_and(index, 1), jnp.cos(y), jnp.sin(y))



x = jnp.mgrid[:l, :width][0]
print("x", x, x.shape)
y = P(x[15])
print("y", y, y.shape)

# i = 3 -> sin(15/(10000^(2/768))) = 0.87404262115
# 0.65028787 -0.7596879 0.8740425 -0.48584944 ... 0.0015364117 0.9999988
for i in range(width):
    print(P_validation(15, i), end=" ")

print()

encoding = jnp.apply_along_axis(P, 1, x)
# [ 0.65028787 -0.7596879   0.8740425  -0.48584944, ..., 0.00153641  0.9999988 ] (281, 768)
print(encoding[15], encoding.shape)
# (1, 281, 768)
print(jnp.asarray(encoding, jnp.float32)[None, :, :].shape)



# x [[  0   0   0 ...   0   0   0]
#  [  1   1   1 ...   1   1   1]
#  [  2   2   2 ...   2   2   2]
#  ...
#  [278 278 278 ... 278 278 278]
#  [279 279 279 ... 279 279 279]
#  [280 280 280 ... 280 280 280]] (281, 768)

# y [ 0.65028787 -0.7596879   0.8740425  -0.48584944  0.98718566 -0.15957604
#   0.9840957   0.17763916  0.8730357   0.48765627  0.6731181   0.73953503
#   0.41058373  0.9118229   0.11499028  0.9933666  -0.18424939  0.9828795
#  -0.4606598   0.8875768  -0.6926911   0.72123444 -0.8648742   0.50198877
#  -0.96820617  0.2501535  -0.9999055  -0.01374707 -0.962692   -0.2705995
#  -0.8637582  -0.50390655 -0.7135858  -0.70056784 -0.52473474 -0.85126585
#  -0.31071636 -0.9505027  -0.08498991 -0.9963818   0.13983144 -0.9901753
#   0.35258538 -0.93577963  0.54396826 -0.8391058   0.7067502  -0.7074632
#   0.8358385  -0.54897547  0.92820925 -0.37205866  0.9827421  -0.18498114
#   0.99998987  0.00449527  0.98190457  0.18937647  0.9315475   0.36361963
#   0.85280216  0.52223414  0.7500985   0.66132617  0.6281692   0.7780768
#   0.4918305   0.870691    0.3458015   0.9383077   0.19456442  0.98088974
#   0.04224967  0.99910706 -0.10744326  0.9942112  -0.2512873   0.96791255
#  -0.38656205  0.9222634  -0.51104915  0.8595515  -0.6230245   0.78220236
#  -0.7212279   0.6926979  -0.8048325   0.59350204 -0.87339705  0.48700887
#  -0.926827    0.37548864 -0.9653233   0.26105723 -0.9893355   0.14565492
#  -0.9995187   0.03102235 -0.9966896  -0.08130101 -0.9817872  -0.18998404
#  -0.95583785 -0.2938946  -0.91992307 -0.39209893 -0.87515205 -0.48384804
#  -0.82263875 -0.5685644  -0.7634813  -0.6458299  -0.69874567 -0.7153702
#  -0.6294557  -0.7770364  -0.5565773  -0.8307958  -0.4810185  -0.8767104
#  -0.40361843 -0.9149274  -0.32514554 -0.945664   -0.24630083 -0.96919346
#  -0.16771251 -0.98583597 -0.08993792 -0.99594736 -0.01346866 -0.9999093
#   0.06126681 -0.99812144  0.13390435 -0.9909943   0.20413512 -0.97894275
#   0.2717041  -0.9623808   0.3364053  -0.9417173   0.39807856 -0.9173513
#   0.45660326 -0.88967043  0.5118968  -0.859047    0.56390834 -0.8258374
#   0.6126167  -0.7903802   0.65802705 -0.7529943   0.70016617 -0.71397996
#   0.73907954 -0.6736182   0.77483064 -0.63216895  0.80749553 -0.58987373
#   0.83716214 -0.5469549   0.8639277  -0.50361586  0.887897   -0.46004224
#   0.9091799  -0.4164035   0.92789143 -0.3728505   0.94414824 -0.32952106
#   0.9580692  -0.2865369   0.9697736  -0.24400657  0.9793803  -0.20202522
#   0.987007   -0.1606771   0.9927697  -0.12003428  0.9967821  -0.08015873
#   0.99915487 -0.0411041   0.99999577 -0.00291328  0.99940896  0.03437672
#   0.997495    0.0707372   0.99435055  0.1061461   0.9900684   0.14058648
#   0.9847373   0.17404735  0.9784417   0.20652315  0.97126234  0.2380114
#   0.9632758   0.26851392  0.9545545   0.29803643  0.94516724  0.32658678
#   0.9351787   0.35417628  0.92465     0.38081798  0.9136389   0.40652677
#   0.90219915  0.43131968  0.8903816   0.455215    0.8782335   0.47823215
#   0.8657995   0.50039107  0.8531207   0.5217136   0.84023595  0.542221
#   0.82718104  0.56193554  0.8139892   0.58088005  0.80069155  0.59907687
#   0.78731674  0.61654884  0.7738908   0.6333191   0.7604387   0.64940983
#   0.7469827   0.66484356  0.7335433   0.6796428   0.72013956  0.69382924
#   0.7067889   0.7074245   0.6935068   0.7204501   0.6803082   0.7329262
#   0.6672058   0.74487346  0.65421146  0.7563117   0.641336    0.76726013
#   0.6285889   0.77773774  0.61597866  0.7877629   0.6035132   0.797353
#   0.59119916  0.80652565  0.5790422   0.8152976   0.567048    0.82368475
#   0.55522084  0.831703    0.5435645   0.83936745  0.5320825   0.84669256
#   0.5207773   0.8536926   0.5096511   0.8603812   0.49870583  0.86677134
#   0.48794267  0.8728757   0.4773624   0.8787065   0.4669658   0.8842754
#   0.45675293  0.8895936   0.4467235   0.8946721   0.43687743  0.89952105
#   0.4272139   0.9041506   0.417732    0.9085703   0.4084308   0.9127893
#   0.39930898  0.9168164   0.39036483  0.92066026  0.3815971   0.92432874
#   0.37300396  0.92782974  0.3645833   0.93117076  0.3563335   0.93435884
#   0.3482523   0.9374008   0.34033746  0.9403034   0.332587    0.94307256
#   0.3249985   0.94571453  0.31756946  0.94823503  0.31029776  0.9506394
#   0.30318075  0.9529331   0.29621604  0.955121    0.28940126  0.95720786
#   0.28273377  0.9591984   0.27621096  0.961097    0.2698306   0.9629078
#   0.26358995  0.96463484  0.25748652  0.9662819   0.25151786  0.96785265
#   0.24568138  0.96935064  0.23997457  0.9707792   0.23439507  0.97214144
#   0.22894038  0.97344047  0.22360788  0.9746792   0.21839541  0.97586036
#   0.21330044  0.97698665  0.20832056  0.9780606   0.20345351  0.9790846
#   0.198697    0.980061    0.19404858  0.9809919   0.18950626  0.98187953
#   0.18506762  0.9827258   0.18073049  0.98353267  0.17649281  0.9843019
#   0.1723524   0.98503536  0.16830711  0.9857346   0.16435502  0.98640126
#   0.16049406  0.9870368   0.15672216  0.9876427   0.15303753  0.9882204
#   0.14943814  0.9887711   0.1459221   0.9892961   0.14248762  0.9897966
#   0.13913296  0.9902737   0.1358562   0.99072856  0.13265564  0.9911622
#   0.12952968  0.99157554  0.1264765   0.9919696   0.12349451  0.9923453
#   0.12058219  0.9927033   0.11773782  0.99304473  0.11495994  0.9933701
#   0.11224708  0.9936803   0.10959765  0.99397606  0.10701026  0.9942579
#   0.10448354  0.9945266   0.102016    0.99478275  0.09960634  0.99502695
#   0.09725328  0.99525964  0.09495541  0.99548155  0.0927115   0.995693
#   0.09052039  0.9958946   0.08838072  0.9960868   0.08629136  0.99626994
#   0.0842512   0.9964445   0.08225902  0.996611    0.08031373  0.9967696
#   0.07841428  0.9969209   0.07655955  0.997065    0.07474852  0.9972024
#   0.07298019  0.9973334   0.07125352  0.9974582   0.06956757  0.99757725
#   0.06792141  0.9976907   0.06631407  0.9977988   0.06474464  0.99790186
#   0.06321231  0.9980001   0.06171609  0.9980937   0.06025521  0.998183
#   0.05882886  0.99826807  0.05743617  0.9983492   0.05607637  0.9984265
#   0.05474873  0.99850017  0.05345244  0.9985704   0.05218676  0.9986373
#   0.05095105  0.99870116  0.04974452  0.99876195  0.04856651  0.99881995
#   0.04741638  0.9988752   0.04629342  0.9989279   0.04519702  0.9989781
#   0.04412658  0.99902594  0.04308143  0.99907154  0.042061    0.99911505
#   0.04106474  0.9991565   0.04009204  0.999196    0.03914234  0.99923366
#   0.03821514  0.99926955  0.03730987  0.99930376  0.03642602  0.99933636
#   0.03556311  0.9993674   0.0347206   0.99939704  0.03389804  0.9994253
#   0.03309496  0.99945223  0.03231089  0.99947786  0.03154538  0.9995023
#   0.030798    0.9995256   0.03006832  0.99954784  0.0293559   0.999569
#   0.02866037  0.9995892   0.0279813   0.99960846  0.0273183   0.9996268
#   0.02667103  0.9996443   0.02603907  0.9996609   0.02542207  0.9996768
#   0.02481971  0.99969196  0.0242316   0.9997064   0.02365741  0.9997201
#   0.02309684  0.9997332   0.02254954  0.9997457   0.0220152   0.99975765
#   0.02149353  0.999769    0.02098421  0.9997798   0.02048695  0.99979013
#   0.02000149  0.99979997  0.01952751  0.9998093   0.01906476  0.99981827
#   0.01861299  0.9998268   0.01817191  0.9998349   0.01774128  0.9998426
#   0.01732086  0.99985     0.0169104   0.999857    0.01650966  0.9998637
#   0.01611842  0.99987006  0.01573644  0.9998762   0.01536352  0.999882
#   0.01499944  0.9998875   0.01464398  0.9998928   0.01429694  0.9998978
#   0.01395813  0.9999026   0.01362734  0.99990714  0.01330439  0.9999115
#   0.0129891   0.99991566  0.01268127  0.9999196   0.01238074  0.99992335
#   0.01208734  0.9999269   0.01180088  0.9999304   0.01152121  0.9999336
#   0.01124818  0.99993676  0.0109816   0.9999397   0.01072135  0.99994254
#   0.01046727  0.9999452   0.0102192   0.9999478   0.00997701  0.99995023
#   0.00974057  0.99995255  0.00950973  0.99995476  0.00928435  0.9999569
#   0.00906432  0.99995893  0.0088495   0.99996084  0.00863977  0.9999627
#   0.00843502  0.9999644   0.00823511  0.9999661   0.00803995  0.9999677
#   0.00784941  0.9999692   0.00766338  0.9999706   0.00748176  0.999972
#   0.00730445  0.9999733   0.00713133  0.99997455  0.00696232  0.99997574
#   0.00679732  0.9999769   0.00663623  0.999978    0.00647895  0.999979
#   0.00632541  0.99998     0.00617549  0.9999809   0.00602914  0.9999818
#   0.00588625  0.99998266  0.00574675  0.9999835   0.00561055  0.99998426
#   0.00547758  0.999985    0.00534777  0.9999857   0.00522103  0.99998635
#   0.00509729  0.999987    0.00497648  0.9999876   0.00485854  0.9999882
#   0.0047434   0.99998873  0.00463098  0.9999893   0.00452123  0.9999898
#   0.00441408  0.9999903   0.00430946  0.9999907   0.00420733  0.9999912
#   0.00410762  0.99999154  0.00401027  0.99999195  0.00391523  0.9999923
#   0.00382244  0.99999267  0.00373184  0.999993    0.0036434   0.9999934
#   0.00355705  0.9999937   0.00347275  0.999994    0.00339045  0.9999943
#   0.0033101   0.9999945   0.00323165  0.99999475  0.00315506  0.999995
#   0.00308028  0.99999523  0.00300728  0.99999547  0.00293601  0.9999957
#   0.00286643  0.9999959   0.00279849  0.99999607  0.00273217  0.99999624
#   0.00266742  0.9999964   0.0026042   0.9999966   0.00254248  0.9999968
#   0.00248222  0.9999969   0.00242339  0.9999971   0.00236596  0.9999972
#   0.00230989  0.9999973   0.00225514  0.99999744  0.0022017   0.99999756
#   0.00214952  0.9999977   0.00209857  0.9999978   0.00204884  0.9999979
#   0.00200028  0.999998    0.00195287  0.9999981   0.00190659  0.9999982
#   0.00186141  0.9999983   0.00181729  0.99999833  0.00177422  0.99999845
#   0.00173217  0.9999985   0.00169112  0.99999857  0.00165104  0.9999986
#   0.00161191  0.9999987   0.00157371  0.99999875  0.00153641  0.9999988 ] (768,)
